filter {
  if [@metadata][stage] == 'suricata_json' {
    if [dns] {

      # Rename fields to ECS-style names
      mutate {
        rename => {
          "[dns][rrname]" => "[dns][question][name]"
          "[dns][rrtype]" => "[dns][question]type]"
          "[dns][rdata]" => "[dns][answers][name]"
          "[dns][rcode]" => "[dns][status_code]"
        }
      }

      if [dns][type] == 'answer' {
        # We can only do this analysis when there's a DNS response
        ruby {
          path => "/etc/logstash/ruby/logstash-ruby-filter-dns-related.rb"
          script_params => {
            "query_field" => "[dns][question][name]"
            "query_type_field" => "[dns][question]type]"
            "answers_field" => "[dns][answers][name]"
          }
        }
      }

    }
  }
}
